<!doctype html>
<html><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>miaou</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/0/img/favicon.ico">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.1.8/semantic.min.css">
</head><body>

<style>
.main.container {
  padding-top: 1em;
}

.segment {
  height: 100%;
  width: 100%;
  overflow: hidden;
}

.comments {
  overflow-y: hidden;
  padding-right: 17px;
}

</style>

<div class="ui main text container">

  <h3 class="ui centered header">miaou</h3>

  <div class="ui padded segment">
    <div class="ui comments">
    </div>
  </div>

  <div class="ui fluid input chatbar">
    <input type="text" id="send">
  </div>

</div>

<script src="https://thbkrkr.github.io/s.js/dist/s.5.f1202eb.js"></script><script>

// WS

var ws
var greet = false

function createWebSocket() {
  wsProto = 'ws:'
  if (window.location.protocol == 'https:') {
    wsProto = 'wss:'
  }

  ws = new WebSocket(wsProto + '//' + window.location.host + '/ws')

  $('#send').attr('placeholder', 'Send a message...')

  ws.onopen = function() {
    attempts = 1
    if (!greet) {
      greet = true
      msg = {user: user, message: "Hello!" }
      ws.send(JSON.stringify({message: JSON.stringify(msg)}))
      $('.comments').append(comment('hello-bot', '<i>Welcome ' + username(msg.user) + '!</i>'))
    }
  }

  ws.onmessage = function(event) {
    msg = JSON.parse(JSON.parse(event.data))
    $('.comments').append(comment(msg.user, msg.message))
    scrollToBottom($('.comments'), 100)
  }

  ws.onerror = function(event) {
  }

  ws.onclose = function(event) {
    var time = generateInterval(attempts);
    $('#send').attr('placeholder', 'Connexion lost, retry in ' + (time/1000) + ' s...')
    setTimeout(function () {
        attempts++
        createWebSocket()
    }, time)
  }
}

function generateInterval (k) {
  return Math.min(15, (Math.pow(2, k) - 1)) * 1000;
}

function say() {
  sendInput = $('#send')
  message = sendInput.val()
  msg = {user: user, message: message }
  ws.send(JSON.stringify({message: JSON.stringify(msg)}))
  sendInput.val('')
}

function comment(user, message) {
  return `
    <div class="comment">
      <div class="avatar">
        <img src="` + avatar(user) + `">
      </div>
      <div class="content">
        <a class="author"> ` + username(user) + ` </a>
        <div class="metadata">
          <span class="date">` + moment().fromNow() + `</span>
        </div>
        <div class="text">
          ` + message + `
        </div>
      </div>
    </div>`
}

//

function scrollToBottom(element, duration) {
  var el  = element[0];
  var startPosition = el.scrollTop
  var delta = el.scrollHeight - element.height() - startPosition

  var startTime = Date.now();

  function scroll() {
    var fraction = Math.min(1, (Date.now() - startTime) / duration)
    el.scrollTop = delta * fraction + startPosition
    if(fraction < 1) {
      setTimeout(scroll, 10)
    }
  }
  scroll()
}

//

users = [
  'jenny', 'joe', 'laura', 'justen', 'helen', 'elliot',
  'daniel', 'stevie', 'veronika'
]

function avatar(user) {
  if (user.indexOf('bot') != -1) {
    return '/0/img/bot.png'
  } else {
    userId = user.split('-')[1]
    return '/0/img/' + users[userId] + '.jpg'

  }
}

function username(user) {
  return userId = user.split('-')[0]
}

function setupUser() {
  user = $lsGet('user')
  if (!user) {
    while (!user) {
      user = prompt('Enter your name', '');
    }
    user = user + '-' + Math.floor(Math.random() * (users.length-1))
    $lsSet('user', user)
  }
}

function setCommentsHeight() {
  $('.comments').height($(window).height()-200)
}

//


setCommentsHeight()
setupUser()
createWebSocket()

$('#send').on('change', say)
$('#send').focus()

window.onresize = setCommentsHeight

</script></body></html>
