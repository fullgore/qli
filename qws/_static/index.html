<!doctype html>
<html><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>miaou</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/s/img/favicon.ico">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css">
</head><body>

<style>
.main.container {
  padding-top: 1em;
}

.segment {
  height: 100%;
  width: 100%;
  overflow-y: hidden;
}

.ui.comments {
  overflow-y: scroll;
  max-width: 1127px;
}

pre {
  color: #565656;
  background: #f5f5f5;
  padding: 10px;
  font-size: 0.8em;
  max-height: 200px;
  margin-right: 10px;
}
</style>

<div class="ui main container">

  <h3 class="ui centered header">miaou</h3>

  <div class="ui segment">
    <div class="ui comments">
    </div>
  </div>

  <div class="ui fluid input chatbar">
    <input type="text" id="send">
  </div>

</div>

<script src="https://thbkrkr.github.io/s.js/dist/s.11.ef9e3d2.zm.js"></script>
<!-- <script src="https://thbkrkr.github.io/s.js/dist/s.8.96a5c7d.zm.js"></script>
 -->
<!-- <script>
(function(){
   //@ Scroll to the bottom of an element in a given duration
  this.$scrollToBottom = function $scrollToBottom(element, duration) {
    var el  = element[0]
    var startPosition = el.scrollTop
    var delta = el.scrollHeight - element.height() - startPosition

    var startTime = Date.now()

    function scroll() {
      var fraction = Math.min(1, (Date.now() - startTime) / duration)
      el.scrollTop = delta * fraction + startPosition
      if(fraction < 1) {
        setTimeout(scroll, 10)
      }
    }
    scroll()
  }

  //@ Resize the element height to the window height less a given height
  this.$setElementHeight = function $setElementHeight(elemClass, height) {
    $(elemClass).height($(window).height() - height)
  }

  var _wsCtx = {
    attempts: 0
  }

  this.$ws = function (path, onopenF, oncloseF, onmessageF) {
    wsProto = 'ws:'
    if (window.location.protocol == 'https:') {
      wsProto = 'wss:'
    }

    ws = new WebSocket(wsProto + '//' + window.location.host + path)

    ws.onopen = function() {
      _wsCtx.attempts = 1
      onopenF(path, onopenF)
    }

    ws.onmessage = function(event) {
      onmessageF(event)
    }

    function _generateInterval(k) {
      return Math.min(15, (Math.pow(2, k) - 1)) * 1000
    }

    ws.onclose = function(event) {
      var time = _generateInterval(_wsCtx.attempts)
      oncloseF(time)
      setTimeout(function () {
          _wsCtx.attempts++
          ws = $ws(path, onopenF, oncloseF, onmessageF)
      }, time)
    }

    return ws
  }
})()
</script> -->

<script>

topic = $param('t') || 'thbkrkr.miaou'

$ws('/ws?topic='+topic,
  function onopen() {
    $('#send').attr('placeholder', 'Send a message...')
    event = {user: user, message: "Hello!" }
    ws.send(JSON.stringify(event))
    $('.comments').append(HTMLmessage({
      user: 'hello~bot-bot',
      message:'<i>Welcome ' + username(event.user) + '!</i>'
    }))
  },
  function onclose(time) {
    $('#send').attr('placeholder', 'Connexion lost, retry in ' + (time/1000) + ' s...')
  },
  function onmessage(event) {
    try {
      event = JSON.parse(JSON.parse(event.data))
    } catch (e) {
      // break
      return
    }
    console.log('event', event)
    if (!event.message) {
      console.error(event.message)
      // break
      return
    }

    if (event.id) {
      $(event.id).append("\n"+cmdOutput(event))
    } else {
      $('.comments').append(HTMLmessage(event))
    }

    $scrollToBottom($('.comments'), 100)
  }
)

function cmdOutput(event) {
  message = event.message
  if (event.b64 === "true") {
    try {
      message = atob(message)
    } catch(e) {
    }
  }
  return message
}

function HTMLmessage(msg) {
  message = msg.message

  b64 = /[A-Za-z0-9+/]{14}[A-Za-z0-9+/=]*/
  b64Decoded = false
  if (b64.test(message)) {
    try {
      message = atob(message)
      message = '<pre>'+message+'</pre>'
      b64Decoded = true
    } catch(e) {
    }
  }

  if (!b64Decoded && msg.b64 === "true") {
    try {
      message = atob(message)
    } catch(e) {
    }
  }
  try {
    json = JSON.parse(message)
    message = '<table>'
    for (var i in json) {
      for (var k in json[i]) {
        message += json[i][k] + ', '
      }
    }
  } catch(e) {
  }

  return `
    <div class="comment">
      <div class="avatar">
        <img src="` + avatar(msg.user) + `">
      </div>
      <div class="content">
        <a class="author"> ` + username(msg.user) + ` </a>
        <div class="metadata">
          <span class="date">` + moment().fromNow() + `</span>
        </div>
        <div class="text">
          ` + message + `
        </div>
      </div>
    </div>`
}

function avatar(user) {
  if (user && user.indexOf('bot') != -1) {
    frags = user.split('-')
    id = frags[frags.length-1]
    return '/s/img/'+id+'.png'
  } else {
    userId = Math.floor(Math.random() * (users.length-1))
    parts = user.split('-')
    if (parts.length > 1) {
      userId = user.split('-')[1]
    }
    return '/s/img/' + users[userId] + '.jpg'

  }
}

function username(user) {
  return user.split('-')[0]
}

var messages = []
var index = -1

// Send event using WS
function say() {
  var input = $('#send')
  var value = input.val()
  if (!value) {
    return
  }
  input.val('')
  if (value == 'clear') {
    $('.comments').empty()
    return
  }

  ws.send(JSON.stringify({user: user, message: value}))
  messages.push(value)
  index = messages.length
}

$(document).keydown(function(e) {
    //console.log(e.which)
    switch(e.which) {
        case 38: // up
        if (index == -1) {
          break
        }
        index--
        $('#send').val(messages[index])
        break

        case 40: // down
        if (index == messages.length) {
          break
        }
        index++
        $('#send').val(messages[index])
        break

        case 13: // enter
        say()
        break

        default: return // exit this handler for other keys
    }
    e.preventDefault() // prevent the default action (scroll / move caret)
})

//

users = [
  'jenny', 'joe', 'laura', 'justen', 'helen', 'elliot',
  'daniel', 'stevie', 'veronika'
]

function setupUser() {
  user = $lsGet('user')
  if (!user) {
    while (!user) {
      user = prompt('Enter your name', '')
    }
    user = user + '@web-' + Math.floor(Math.random() * (users.length-1))
    $lsSet('user', user)
  }
}

//

setupUser()

$setElementHeight('.comments', 145)
window.onresize = function() {
  $setElementHeight('.comments', 145)
}

$('#send').on('change', say)
$('#send').focus()

</script></body></html>
