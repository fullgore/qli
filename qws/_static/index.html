<!doctype html>
<html><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>miaou</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="/s/img/favicon.ico">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css">
</head><body>

<style>
.main.container {
  padding-top: 1em;
}

.segment {
  height: 100%;
  width: 100%;
  overflow-y: hidden;
}

.ui.comments {
  overflow-y: scroll;
  max-width: 1127px;
}

pre {
  color: #565656;
  background: #f5f5f5;
  padding: 10px;
  font-size: 0.8em;
  max-height: 200px;
  margin-right: 10px;
}
</style>

<div class="ui main container">

  <h3 class="ui centered header">miaou</h3>

  <div class="ui segment">
    <div class="ui comments">
    </div>
  </div>

  <div class="ui fluid input chatbar">
    <input type="text" id="send">
  </div>

</div>

<script src="https://thbkrkr.github.io/s.js/dist/s.11.a58e2db.zm.js"></script>
<script>

topic = $param('t') || 'thbkrkr.miaou'

$WS('/ws?topic='+topic,
  function() {
    $('#send').attr('placeholder', 'Send a message...')
    event = {user: user, message: "Hello!" }
    $ws.send(JSON.stringify(event))
    $('.comments').append(HTMLmessage({
      user: 'hello~bot-bot',
      message:'<i>Welcome ' + username(event.user) + '!</i>'
    }))
  },
  function onmessage(event) {
    //console.log('event.data)
    try {
      event = JSON.parse(JSON.parse(event.data))
    } catch (e) {
      // break
      return
    }
    if (!event.message) {
      console.error(event.message)
      // break
      return
    }
    console.log('event', event)

    if (event.id) {
      $(event.id).append("\n"+cmdOutput(event))
    } else {
      $('.comments').append(HTMLmessage(event))
    }
    $scrollToBottom($('.comments'), 100)
  }
)

function cmdOutput(event) {
  var message = event.message
  if (event.b64 === "true") {
    try {
      message = atob(message)
    } catch(e) {
    }
  }
  return message
}

function HTMLmessage(msg) {
  var message = msg.message

  if (msg.b64 === "true") {
    try {
      message = atob(message)
    } catch(e) {
    }
  }
  try {
    json = JSON.parse(message)
    message = '<table>'
    for (var i in json) {
      for (var k in json[i]) {
        message += json[i][k] + ', '
      }
    }
  } catch(e) {
  }

  return `
    <div class="comment">
      <div class="avatar">
        <img src="` + avatar(msg.user) + `">
      </div>
      <div class="content">
        <a class="author"> ` + username(msg.user) + ` </a>
        <div class="metadata">
          <span class="date">` + moment().fromNow() + `</span>
        </div>
        <div class="text">
          ` + message + `
        </div>
      </div>
    </div>`
}

function avatar(user) {
  if (user && user.indexOf('bot') != -1) {
    frags = user.split('-')
    id = frags[frags.length-1]
    return '/s/img/'+id+'.png'
  } else {
    userId = Math.floor(Math.random() * (users.length-1))
    parts = user.split('-')
    if (parts.length > 1) {
      userId = user.split('-')[1]
    }
    return '/s/img/' + users[userId] + '.jpg'

  }
}

function username(user) {
  return user.split('-')[0]
}

var messages = []
var index = -1

// Send event using WS
function say() {
  var input = $('#send')
  var value = input.val()
  if (!value) {
    return
  }
  input.val('')
  if (value == 'clear') {
    $('.comments').empty()
    return
  }

  $ws.send(JSON.stringify({user: user, message: value}))
  messages.push(value)
  index = messages.length
}

$(document).keydown(function(e) {
    //console.log(e.which)
    switch(e.which) {
        case 38: // up
        if (index == -1) {
          break
        }
        index--
        $('#send').val(messages[index])
        break

        case 40: // down
        if (index == messages.length) {
          break
        }
        index++
        $('#send').val(messages[index])
        break

        case 13: // enter
        say()
        break

        default: return // exit this handler for other keys
    }
    e.preventDefault() // prevent the default action (scroll / move caret)
})

//

users = [
  'jenny', 'joe', 'laura', 'justen', 'helen', 'elliot',
  'daniel', 'stevie', 'veronika'
]

function setupUser() {
  user = $lsGet('user')
  if (!user) {
    while (!user) {
      user = prompt('Enter your name', '')
    }
    user = user + '@web-' + Math.floor(Math.random() * (users.length-1))
    $lsSet('user', user)
  }
}

//

setupUser()

$setElementHeight('.comments', 145)
window.onresize = function() {
  $setElementHeight('.comments', 145)
}

$('#send').on('change', say)
$('#send').focus()

</script></body></html>
