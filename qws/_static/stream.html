<!doctype html>
<html><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>docker-stream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="docker-stream">
  <link rel="apple-touch-icon" href="/s/img/bot2.png">
  <link rel="icon" sizes="196x196" href="/s/img/bot2.png">
  <link rel="shortcut icon" type="image/png" href="/s/img/bot2.png">
  <link rel="manifest" href="/s/manifest.json">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.7/semantic.min.css">

</head><body>
<style>

body {
  padding: 10px;
  font-size: 0.8em;
}

.ctn {
  height: 24px;
  max-width: 24px;
  border: 1px white solid;
  background-color: #dadada;
  padding-left: 0.5rem !important;
  padding-right: 0.5rem !important;
  padding-top: 0.5rem !important;
  padding-bottom: 0.5rem !important;
}

div.status-exec_start,
div.status-start,
div.status-running {
  background-color: #00BCD4;
}

div.status-exec_create,
div.status-create,
div.status-created {
  background-color: #cddc39;
}

div.status-stop,
div.status-exited {
  background-color: #ff9800;
}

div.status-die,
div.status-kill {
  background-color: #e91e63;
}

div.status-destroy {
  background-color: #f44336;
}

</style>

<div id="counters" class="text container">
 <!--  <div class="ui mini horizontal statistic">
    <div id="statuses-total" class="value">0</div>
    <div class="label">containers</div>
  </div>
  <div class="ui mini horizontal statistic">
    <div id="statuses-running" class="value">0</div>
    <div class="label">running</div>
  </div>
  <div class="ui mini horizontal statistic">
    <div id="statuses-create" class="value">0</div>
    <div class="label">create</div>
  </div>
  <div class="ui mini horizontal statistic">
    <div id="statuses-stop" class="value">0</div>
    <div class="label">stop</div>
  </div>
  <div class="ui mini horizontal statistic">
    <div id="statuses-exited" class="value">0</div>
    <div class="label">exited</div>
  </div>
  <div class="ui mini horizontal statistic">
    <div id="statuses-kill" class="value">0</div>
    <div class="label">kill</div>
  </div>
  <div class="ui mini horizontal statistic">
    <div id="statuses-die" class="value">0</div>
    <div class="label">die</div>
  </div>
  <div class="ui mini horizontal statistic">
    <div id="statuses-destroy" class="value">0</div>
    <div class="label">destroy</div>
  </div> -->
</div>
<div id="main" class="container"></div>

<script src="https://thbkrkr.github.io/s.js/dist/s.11.ef9e3d2.zm.js"></script>
<script>

var ctns = {}

var counters = {
  total: 0,
  destroy: 0
}

function renderCounters() {
  var c = {
    total: counters.total,
    create: 0,
    start: 0,
    running: 0,
    stop: 0,
    exited: 0,
    kill: 0,
    die: 0,
    destroy: 0,
    'total destroy': counters.destroy
  }
  for (var k in ctns) {
    c[ctns[k]] += 1
  }
  stats = ''
  for (var s in c) {
    stats +=
      `<div class="ui mini horizontal statistic">
        <div id="statuses-total" class="value">${c[s]}</div>
        <div class="label">${s}</div>
      </div>`
  }
  $('#counters').html(stats)
}

$ws('/ws?topic='+($param('topic') || 'thbkrkr.miaou'),
  function onopen() {},
  function onclose(time) {},
  function onmessage(event) {
    try {
      event = JSON.parse(event.data)
    } catch (e) {
      return
    }
    if (!event || !event.Host) return

    host = event.Host
    hostId = host.replace(/\./g, '-')
    hostElem = document.getElementById(hostId)
    status = event.Status.split(':')[0]
    clazz = `column ctn status-${status}`
    title = `status=${status} name=${event.Name} image=${event.Image}`
    ctnElem = document.getElementById(event.ID)

    filter = $param('filter')
    if (filter != null) {
      console.log(title.indexOf(filter))
      if (title.indexOf(filter) == -1) {
        return
      }
    }

    if (!counters.total) counters.total = 0

    // Add host
    if (!hostElem) {
      $('#main').append(`
        <div class="ui mini horizontal statistic host">
          <div class="value" id="count-${hostId}">0</div>
          <div class="label">${host}</div>
        </div>
        <div id="${hostId}" class="ui aligned padded grid">
        </div>`)

      // Refresh host elem
      hostElem = document.getElementById(hostId)
    }

    hostCountElem = $(`#count-${hostId}`)
    hostCount = 0

    // Remove destroyed ctn
    if (ctnElem && status == 'destroy') {
      $(ctnElem).remove()

      counters.total--
      counters.destroy++
      hostCount = hostCountElem.html()*1-1
      hostCountElem.html(hostCount)

      delete ctns[event.ID]
      renderCounters()
      return
    }

    // Add ctn
    if (!ctnElem) {
      $(hostElem).append(`<div id="${event.ID}"  class="${clazz}" title="${title}"></div>`)

      counters.total++
      hostCount = hostCountElem.html()*1+1
      hostCountElem.html(hostCount)
    }
    else {
      // Update ctn
      $(ctnElem).attr('title', title)
      $(ctnElem).attr('class', clazz)
    }

    ctns[event.ID] = status
    renderCounters()
  }
)

</script></body>
</html>
